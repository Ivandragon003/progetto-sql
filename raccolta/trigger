
CREATE OR REPLACE FUNCTION checkRistorante()
RETURNS TRIGGER AS $$
DECLARE
    cont INTEGER;
BEGIN
    SELECT COUNT(*) INTO cont
    FROM lavora
    WHERE idRistorante = OLD.idRistorante
      AND codFiscale <> OLD.codFiscale;

    IF cont = 0 THEN
        RAISE EXCEPTION 'Non puoi lasciare il ristorante % senza chef.', OLD.idRistorante;
    END IF;

    RETURN OLD;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_checkRistorante
BEFORE DELETE ON lavora
FOR EACH ROW
EXECUTE FUNCTION checkRistorante();



CREATE OR REPLACE FUNCTION checkCorsoUtente() 
RETURNS TRIGGER AS $$
DECLARE 
	cont INT ;
BEGIN 
	SELECT COUNT(*) INTO cont
	FROM iscritto
	WHERE idCorsoCucina <>idCorsoCucina ;
	IF cont = 0 THEN
        DELETE FROM corsoCucina WHERE idCorsoCucina = OLD.idCorsoCucina;
    END IF;

    RETURN NULL; 
END;
$$ LANGUAGE plpgsql;


CREATE TRIGGER trg_checkCorsoUtente
AFTER DELETE ON iscritto 
FOR EACH ROW
EXECUTE FUNCTION checkCorsoUtente();
